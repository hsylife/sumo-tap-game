<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sumo Tap Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* スクロールしない */
      font-family: sans-serif;
      background-color: #f5f5f5;
      box-sizing: border-box;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      text-align: center;
    }

    header {
      flex: 0 0 auto;
      padding: 10px 0;
      background-color: #f5f5f5;
      color: #333;
      border-bottom: 2px solid #ccc;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
      margin-bottom: 8px;
    }

    .info {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-weight: bold;
    }

    #gameArea {
      position: relative;
      flex: 1 1 auto;
      background-color: #fff;
      overflow: hidden;
    }

    /* お相撲さん / 行司さん 共通 */
    .character {
      position: absolute;
      width: 15vmin;
      height: 15vmin;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s;
    }
    .character:active {
      transform: scale(0.9);
    }

    .sumo {
      /* 必要あればお相撲さんだけのスタイルを追加 */
    }
    .gyoji {
      /* 行司さん用のスタイルを追加 */
    }

    .dosukoi {
      position: absolute;
      padding: 5px 10px;
      background-color: #fde910;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-weight: bold;
      animation: fadeOut 1s forwards;
      pointer-events: none;
    }
    @keyframes fadeOut {
      0%   { opacity: 1; }
      100% { opacity: 0; }
    }

    /* コンボが閾値以上のときに大きく表示する「どすこい！どすこい！」 */
    #comboOverlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      font-weight: bold;
      color: #ff0000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    /* ゲーム終了(「そこまで」)表示 */
    #gameOverOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); /* 半透明の背景 */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 2rem;
      visibility: hidden; /* 初期は非表示 */
    }
    #gameOverOverlay h2 {
      margin: 0 0 20px;
    }
    #restartButton {
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #fde910;
      color: #333;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>お相撲さんをタップしてストレス解消！</h1>
      <div class="info">
        <div>スコア: <span id="score">0</span></div>
        <div>残り時間: <span id="timeLeft">30</span>秒</div>
      </div>
    </header>

    <main id="gameArea">
      <!-- コンボ時の大きな表示 -->
      <div id="comboOverlay">どすこい！どすこい！</div>
      <!-- ゲーム終了画面 -->
      <div id="gameOverOverlay">
        <h2>そこまで</h2>
        <p id="finalScore"></p>
        <button id="restartButton">リスタート</button>
      </div>
    </main>
  </div>

  <script>
    // DOM要素
    const gameArea         = document.getElementById('gameArea');
    const scoreDisplay     = document.getElementById('score');
    const timeLeftDisplay  = document.getElementById('timeLeft');
    const gameOverOverlay  = document.getElementById('gameOverOverlay');
    const finalScore       = document.getElementById('finalScore');
    const restartButton    = document.getElementById('restartButton');
    const comboOverlay     = document.getElementById('comboOverlay');

    // 効果音の準備（同ディレクトリにdosukoi.mp3を置く想定）
    const dosukoiAudio = new Audio('./dosukoi.mp3');

    // ゲーム関連の設定
    let spawnInterval = 1000;       // ミリ秒ごとに出現
    let spawnTimer;                 // setIntervalのID
    const GAME_TIME = 30;           // 制限時間
    let timeLeft    = GAME_TIME;
    let timeCounter;                // 制限時間カウントダウン用

    // スコア・コンボ管理
    let score = 0;
    let combo = 0;

    // 「どすこい！どすこい！」を表示するコンボ閾値(初期3)
    let comboDisplayThreshold = 3;

    // ゲームオーバーかどうかのフラグ
    let isGameOver = false;

    // ----- ゲーム開始 -----
    function startGame() {
      resetGameState();

      // 一定間隔でキャラクター(お相撲さん/行司さん)を生成
      spawnTimer = setInterval(spawnCharacters, spawnInterval);

      // 制限時間カウントダウン
      timeCounter = setInterval(() => {
        timeLeft--;
        timeLeftDisplay.textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame();
        }
      }, 1000);
    }

    // ----- キャラクターのまとめ生成(1~3体) -----
    function spawnCharacters() {
      if (isGameOver) return; // ゲーム終了後は生成しない

      const count = Math.floor(Math.random() * 3) + 1; // 1～3
      for (let i = 0; i < count; i++) {
        spawnOneCharacter();
      }
    }

    // ----- キャラクター(お相撲さん or 行司さん)1体生成 -----
    function spawnOneCharacter() {
      const gameRect = gameArea.getBoundingClientRect();
      const gameWidth = gameRect.width;
      const gameHeight = gameRect.height;
      const size = Math.min(gameWidth, gameHeight) * 0.15;

      // 5% の確率で行司さん
      const isGyoji = Math.random() < 0.05;

      // img要素作成
      const charImg = document.createElement('img');
      charImg.classList.add('character');
      if (isGyoji) {
        charImg.classList.add('gyoji');
        charImg.src = './gyoujisan.png';
      } else {
        charImg.classList.add('sumo');
        charImg.src = './osumousan.png';
      }

      // 画面上端外から落ちてくる
      const startX = Math.random() * (gameWidth - size);
      charImg.style.left = startX + 'px';
      charImg.style.top  = -size + 'px';

      // タップイベント(スマホ/PC両方)
      charImg.addEventListener('touchstart', (e) => onTapCharacter(e, isGyoji, charImg));
      charImg.addEventListener('click',      (e) => onTapCharacter(e, isGyoji, charImg));

      gameArea.appendChild(charImg);

      // 落下アニメーション
      let posY = -size;
      function fall() {
        if (isGameOver || !spawnTimer) {
          // ゲーム終了後はキャラを除去して終わり
          charImg.remove();
          return;
        }
        posY += 2; // 落下速度
        charImg.style.top = posY + 'px';

        // 画面下から外に出たらキャラ削除
        if (posY > gameHeight) {
          // お相撲さんだった場合はコンボリセット
          if (charImg.classList.contains('sumo')) {
            combo = 0;
          }
          charImg.remove();
        } else {
          requestAnimationFrame(fall);
        }
      }
      requestAnimationFrame(fall);
    }

    // ----- タップ時の処理 -----
    function onTapCharacter(event, isGyoji, element) {
      event.preventDefault();

      // ゲームが終わっていたら何もしない
      if (isGameOver) return;

      if (isGyoji) {
        // 行司さん: 減点 & コンボリセット
        score = Math.max(0, score - 5);
        combo = 0;
      } else {
        // お相撲さん: コンボ加算 & スコア加算
        combo++;
        const bonus = 1 + combo; 
        score += bonus;

        // 「どすこい！」吹き出し
        showDosukoi(element.offsetLeft, element.offsetTop);

        // 効果音再生
        dosukoiAudio.currentTime = 0;
        dosukoiAudio.play();

        // コンボが閾値に達したら「どすこい！どすこい！」大きく表示
        if (combo >= comboDisplayThreshold) {
          showDoubleDosukoi();
          // 閾値を引き上げる(次回は +3)
          comboDisplayThreshold += 3;
        }
      }

      scoreDisplay.textContent = score;
      element.remove();
    }

    // ----- 「どすこい！」吹き出し表示 -----
    function showDosukoi(x, y) {
      const text = document.createElement('div');
      text.className = 'dosukoi';
      text.textContent = 'どすこい！';
      text.style.left = (x + 10) + 'px';
      text.style.top  = (y + 10) + 'px';
      gameArea.appendChild(text);

      // 1秒後に消去
      setTimeout(() => {
        text.remove();
      }, 1000);
    }

    // ----- 大きく「どすこい！どすこい！」表示 -----
    function showDoubleDosukoi() {
      comboOverlay.style.opacity = '1';
      // 短時間(0.5秒)で消す
      setTimeout(() => {
        comboOverlay.style.opacity = '0';
      }, 500);
    }

    // ----- ゲーム終了 -----
    function endGame() {
      isGameOver = true;           // 終了フラグON
      clearInterval(spawnTimer);   // スポーン停止
      spawnTimer = null;
      clearInterval(timeCounter);  // 時間カウント停止

      // 結果表示
      finalScore.textContent = `あなたのスコアは ${score} です！`;
      gameOverOverlay.style.visibility = 'visible';
    }

    // ----- ゲーム状態をリセット -----
    function resetGameState() {
      // 各要素の削除
      gameArea.querySelectorAll('.character, .dosukoi').forEach(el => el.remove());

      // スコアや時間の初期化
      score  = 0;
      combo  = 0;
      scoreDisplay.textContent = score;
      timeLeft = GAME_TIME;
      timeLeftDisplay.textContent = timeLeft;
      comboDisplayThreshold = 3;

      // オーバーレイを非表示
      gameOverOverlay.style.visibility = 'hidden';
      comboOverlay.style.opacity = '0';

      // フラグ初期化
      isGameOver = false;
    }

    // リスタートボタン
    restartButton.addEventListener('click', () => {
      startGame();
    });

    // ページ読み込み時にゲーム開始
    window.addEventListener('load', startGame);
  </script>
</body>
</html>
