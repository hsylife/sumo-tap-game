<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sumo Tap Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #f5f5f5;
      box-sizing: border-box;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      text-align: center;
    }
    header {
      flex: 0 0 auto;
      padding: 10px 0;
      background-color: #f5f5f5;
      color: #333;
      border-bottom: 2px solid #ccc;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .info {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-weight: bold;
    }
    /* タイマー表示は削除 */
    #gameArea {
      position: relative;
      flex: 1 1 auto;
      background-color: #fff;
      overflow: hidden;
    }
    /* キャラクター共通 */
    .character {
      position: absolute;
      width: 15vmin;
      height: 15vmin;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s;
    }
    .character:active {
      transform: scale(0.9);
    }
    /* お相撲さんは下層に */
    .sumo {
      z-index: 1;
    }
    /* 行司は常に最前面に */
    .gyoji {
      z-index: 10;
    }
    .dosukoi {
      position: absolute;
      padding: 5px 10px;
      background-color: #fde910;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-weight: bold;
      animation: fadeOut 1s forwards;
      pointer-events: none;
    }
    @keyframes fadeOut {
      0%   { opacity: 1; }
      100% { opacity: 0; }
    }
    /* コンボオーバーレイ */
    #comboOverlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      font-weight: bold;
      color: #ff0000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    /* ゲームオーバーオーバーレイ */
    #gameOverOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 2rem;
      visibility: hidden;
    }
    #gameOverOverlay h2 {
      margin: 0 0 20px;
    }
    #restartButton {
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #fde910;
      color: #333;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>お相撲さんをタップしてストレス解消！</h1>
      <div class="info">
        <div>スコア: <span id="score">0</span></div>
      </div>
    </header>
    <main id="gameArea">
      <!-- コンボ時の大きな表示 -->
      <div id="comboOverlay">どすこい！どすこい！</div>
      <!-- ゲーム終了画面 -->
      <div id="gameOverOverlay">
        <h2>そこまで</h2>
        <p id="finalScore"></p>
        <button id="restartButton">リスタート</button>
      </div>
    </main>
  </div>
  <script>
    // DOM要素
    const gameArea         = document.getElementById('gameArea');
    const scoreDisplay     = document.getElementById('score');
    const gameOverOverlay  = document.getElementById('gameOverOverlay');
    const finalScore       = document.getElementById('finalScore');
    const restartButton    = document.getElementById('restartButton');
    const comboOverlay     = document.getElementById('comboOverlay');

    // 効果音 (dosukoi.mp3 を同ディレクトリに配置)
    const dosukoiAudio = new Audio('./dosukoi.mp3');

    // ゲーム設定
    let spawnInterval = 1000; // ミリ秒ごとに生成
    let spawnTimer;

    // スコア・コンボ管理
    let score = 0;
    let combo = 0;
    let comboDisplayThreshold = 3;

    // 行司出現確率（初期5%）→ spawnCharacters で毎回上昇
    let gyojiSpawnChance = 0.05;

    // ゲームオーバーフラグ
    let isGameOver = false;

    // ----- ゲーム開始 ---------
    function startGame() {
      resetGameState();
      spawnTimer = setInterval(spawnCharacters, spawnInterval);
    }

    // ----- キャラクター生成 -----
    function spawnCharacters() {
      if (isGameOver) return;
      // 行司出現確率を加速（最大20%まで）
      gyojiSpawnChance = Math.min(gyojiSpawnChance + 0.02, 0.2);

      // 10% の確率でフラッドイベント（強制的にお相撲さんのみ生成）
      const floodChance = 0.1;
      let count;
      if (Math.random() < floodChance) {
        count = Math.floor(Math.random() * 11) + 10; // 10～20体
        for (let i = 0; i < count; i++) {
          spawnOneCharacter(true);  // forcedSumo → お相撲さんのみ
        }
      } else {
        count = Math.floor(Math.random() * 3) + 1; // 通常は1～3体
        for (let i = 0; i < count; i++) {
          spawnOneCharacter();
        }
      }
    }

    // ----- キャラクター1体生成 -----
    // forcedSumo が true の場合、必ずお相撲さんとして生成
    function spawnOneCharacter(forcedSumo = false) {
      const gameRect = gameArea.getBoundingClientRect();
      const gameWidth = gameRect.width;
      const gameHeight = gameRect.height;
      const size = Math.min(gameWidth, gameHeight) * 0.15;

      // forcedSumo でなければ、行司出現確率を使用
      const isGyoji = forcedSumo ? false : (Math.random() < gyojiSpawnChance);

      // img 要素作成
      const charImg = document.createElement('img');
      charImg.classList.add('character');
      if (isGyoji) {
        charImg.classList.add('gyoji');
        charImg.src = './gyoujisan.png';
      } else {
        charImg.classList.add('sumo');
        charImg.src = './osumousan.png';
      }

      // タップイベント登録 (タッチ・クリックの両対応)
      charImg.addEventListener('touchstart', (e) => onTapCharacter(e, isGyoji, charImg));
      charImg.addEventListener('click', (e) => onTapCharacter(e, isGyoji, charImg));

      gameArea.appendChild(charImg);

      if (isGyoji) {
        // 行司の場合：画面内のランダムな位置から開始し、ウロウロ移動
        charImg.style.left = (Math.random() * (gameWidth - size)) + 'px';
        charImg.style.top  = (Math.random() * (gameHeight - size)) + 'px';
        let dx = (Math.random() * 4 - 2);
        let dy = (Math.random() * 4 - 2);
        if (dx === 0 && dy === 0) { dx = 1; }
        function wander() {
          if (isGameOver || !spawnTimer) {
            charImg.remove();
            return;
          }
          let currentLeft = parseFloat(charImg.style.left);
          let currentTop  = parseFloat(charImg.style.top);
          let newLeft = currentLeft + dx;
          let newTop  = currentTop + dy;
          // 画面端で反転
          if (newLeft < 0 || newLeft > gameWidth - size) {
            dx = -dx;
            newLeft = currentLeft + dx;
          }
          if (newTop < 0 || newTop > gameHeight - size) {
            dy = -dy;
            newTop = currentTop + dy;
          }
          charImg.style.left = newLeft + 'px';
          charImg.style.top  = newTop + 'px';
          requestAnimationFrame(wander);
        }
        requestAnimationFrame(wander);
      } else {
        // お相撲さんの場合：画面上部外から落下
        const startX = Math.random() * (gameWidth - size);
        charImg.style.left = startX + 'px';
        charImg.style.top  = -size + 'px';
        let posY = -size;
        function fall() {
          if (isGameOver || !spawnTimer) {
            charImg.remove();
            return;
          }
          posY += 2;
          charImg.style.top = posY + 'px';
          // 画面下部外に出たら削除 (タップされなければコンボリセット)
          if (posY > gameHeight) {
            combo = 0;
            charImg.remove();
          } else {
            requestAnimationFrame(fall);
          }
        }
        requestAnimationFrame(fall);
      }
    }

    // ----- タップ時の処理 -----
    function onTapCharacter(event, isGyoji, element) {
      event.preventDefault();
      if (isGameOver) return;
      if (isGyoji) {
        // 行司タップで即ゲームオーバー
        endGame();
        return;
      } else {
        // お相撲さんの場合：コンボ加算＆スコア加算
        combo++;
        const bonus = 1 + combo;
        score += bonus;
        showDosukoi(element.offsetLeft, element.offsetTop);
        const soundClone = dosukoiAudio.cloneNode();
        soundClone.play();
        if (combo >= comboDisplayThreshold) {
          showDoubleDosukoi();
          comboDisplayThreshold += 3;
        }
      }
      scoreDisplay.textContent = score;
      element.remove();
    }

    // ----- 「どすこい！」吹き出し表示 -----
    function showDosukoi(x, y) {
      const text = document.createElement('div');
      text.className = 'dosukoi';
      text.textContent = 'どすこい！';
      text.style.left = (x + 10) + 'px';
      text.style.top  = (y + 10) + 'px';
      gameArea.appendChild(text);
      setTimeout(() => { text.remove(); }, 1000);
    }

    // ----- 大きな「どすこい！どすこい！」表示 -----
    function showDoubleDosukoi() {
      comboOverlay.style.opacity = '1';
      setTimeout(() => { comboOverlay.style.opacity = '0'; }, 500);
    }

    // ----- ゲーム終了 -----
    function endGame() {
      isGameOver = true;
      clearInterval(spawnTimer);
      spawnTimer = null;
      finalScore.textContent = `あなたのスコアは ${score} です！`;
      gameOverOverlay.style.visibility = 'visible';
    }

    // ----- ゲーム状態リセット -----
    function resetGameState() {
      gameArea.querySelectorAll('.character, .dosukoi').forEach(el => el.remove());
      score  = 0;
      combo  = 0;
      scoreDisplay.textContent = score;
      comboDisplayThreshold = 3;
      gyojiSpawnChance = 0.05;
      gameOverOverlay.style.visibility = 'hidden';
      comboOverlay.style.opacity = '0';
      isGameOver = false;
    }

    // リスタートボタンのイベント
    restartButton.addEventListener('click', () => { startGame(); });

    // ページ読み込み時にゲーム開始
    window.addEventListener('load', startGame);
  </script>
</body>
</html>
